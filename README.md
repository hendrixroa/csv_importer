# CSV_Importer

This project was generated by [Nest](https://github.com/nestjs/nest) framework with some custom tools.

# Contents
- [How to Install](#how-to-install)
- [Environment files](#env-files)
- [Configs](#configs)
- [Database configuration](#database-configuration)
- [Development](#development)
- [Swagger docs instance](#swagger-docs-instance)
- [Directory structure](#directory-structure)
- [Logging](#logging)
- Solution design
  - [CSV importer library](#csv-importer-library)
  - [Validate csv data](#validate-csv-data)
  - [Database storing-loading](#database-storing-loading)
  - [Unit testing](#unit-testing)
  
## How to install

Assumptions:

1. The project is configured to be executed in UNIX Linux and macOS(OS X) systems, does not support windows or at least is not a guarantee this projects works on windows platform. 
2. Requires Docker only if you want to run this project with docker, see [Development](#development)
3. Requires g++, make, build-essentials or any equivalent in linux systems, depends on the distro you are using.
4. Requires Node.js 16+
5. Requires `yarn`

Quickstart: 

- Clone or download the project and run: `make install_dependencies`
- On folder *env* copy .test.env content to .env (create .env, it should contain all local variables)
- Creates *api.env* file and customize the environment variables in case you will have multiples apps.
- run: `APP=api make dev_app`
- Open a new window browser or click here [docs](http://[::1]:3000/docs) to see the swagger instance running.

## Environment files

All \*.env files reside in `env` folder

Development env files are **NOT checked out in repo**, they are meant for local development.

- There should be one `.env` for default env variables
- For each app (src/apps folder) there should be one `<app_name>.env` for app specific env variables

Test env files

Test env files are **checked out in repo** so watch out not to save any secrets there.  
They are checked out in repo to make it possible to run tests without creating any .env files "by hand" -
this way this project is test-ready out of the box.

- There is one `.test.env` for default env variables
- For each app there is one `<app_name>.test.env` for app specific env variables

## Configs

All configs should reside on *src/config/* folder, the file *src/config/app.config.ts* contains the minimum environment variables needed to start the application. APPConfig could be extendable to adapt to another app using inheritance.

## Database configuration

The persistence layer is completely delegated by the framework [Typeorm](https://github.com/typeorm/typeorm) using SQLite as database provider which is used in mode *In-Memory* to avoid any installation of on premise database which is out of scope for this project.
Neither database configuration is required, however you can set some variables via *.env files to change a few things in the database provider, for example you can set the variable DATABASE_LOG_LEVEL=true to see all the trace of database when execute all queries. If you want to extend that config check the file *src/config/ormconfig.ts* and extend it according to your needs.
Because this project uses an In-memory database like SQLite we have not migrations or any configuration for repository approach due the incompatibility between nest.js and non-connection persistent of SQLite make no possible to inject custom repositories classes in each module effectively, said that the fix was implemented is to use the connection manager to create a Repository given an entity.  
 
## Development

Following the *Quickstart* section you can run the project quickly, but this project has integrated the Docker image creation and the execution using docker-compose, to run with docker:

```bash
 $ APP=api make build_docker_app
```

This project has integrated the formatter code [Prettier](https://github.com/prettier/prettier) with the ES7 standard formatting to make sure the whole project is coding using it. You can review it using the command:

```bash
$ make lint_formatting
```

Then you can get a format in your code manually. Another option is when you create a git commit of your changes the integrated tool [Husky](https://github.com/typicode/husky) execute a pre-commit hook verifying the staged files, also verify if the project can perform a build using the command *yarn run build* which you can perform manually of course.

## Swagger docs instance

The project has integrated by default a swagger instance in development mode where you can perform the API calls that you register in your app api. Once you finish the steps described in *Quickstart* section you can go to [docs](http://[::1]:3000/docs) to see your API's. That does not mean you can not use Postman or curl command just is an easy way to perform calls and integrate your API with different cloud systems.

## Directory structure

**src/apps**  
Contains applications - parts of main application that should be run in separate modules.
By convention each app is located in a separate folder in src/apps (for example src/apps/api) and contains main.ts file which is an entry point for it.
If it requires some specific configuration it should implement it in src/config/<your_app>Config.ts.

**env**  
Development and test \*.env files.
See [Environment files](#environment-files).

**src/config**  
Service configs.
See [Configs](#configs).

**src/modules**
Each module must contain at lease a module definition according to the Nest.js modules standard creation to be exportable around the application. If the module is a candidate to store/load data a database entity must be created according to the TypeORM framework. The convention name should be:

**yourModule.entity.ts**  
Database models. No business logic should be implemented here.

**Repositories**  
Set of utility classes (repositories) for accessing database provided by TypeORM entity manager.

**yourModule.controller.ts**  
Rest controllers specification, all RestFul decorators, params, query strings capturing should be implemented here.

**yourModule.service.ts**
All business logic should be implemented here, all connection with APIs, persistence layer and more.  

**yourModule.dto.ts** (Optional) 
All DTOs used by your module.

## Logging

In the service layer there is a baseService.ts file that contains the logging service embed to be able used in all services that extend baseService class. The log service uses behind the scenes the library bunyan to stream logs in json format.

## CSV importer library

This project is using the file sending integration that [Nest Upload](https://docs.nestjs.com/techniques/file-upload) provides to handle it easy, another important thing is the process files to parse it and ignore the non-csv files. This project has integrated the library [CSVToJson](https://www.npmjs.com/package/csvtojson) that provides the functionality desired to achieve the goals of these project, the module implemented can be found in *src/modules/importer*, we can list a few functionality that used the importer module: 

- Provides a header configuration that make easy the skipping columns non-desired in the csv files this project is processing. 
- Provides a trim functionality to make sure we are loading clean strings (default).
- Provides the skipping feature for empty rows.
- Allows change the csv delimiter, in this project in your .env change it using the environment variable **CSV_DELIMITER=YourCharDelimiter**.

## Provider lifecycle

The providers name and fields use to mapping to an entity in this case **Vehicle** will be load from the table **importer_providers**, a seeder was implemented to run it before the API.

## Validate csv data

Each row of csv will be validated following the constraints to make sure the data is right, the library use is [Joi](https://joi.dev/) that returns the error detailed to notify to the user the column, the wrong value and the rules that does not match the column-value.

## Database storing-loading

Once the CSV are filtered, and parsed is required to store the data that becomes from csv files the module vehicle was implemented to handle all vehicles actions. The importer module is the responsible for map the csv rows and store in database.
For loading and check the data is storing properly an endpoint was implemented in vehicle module to list all vehicles imported, the rest api definition is GET /vehicles, once you import the files and the process finishes with status 201 you can check your vehicles imported.

Hint: Use the data test inside *data* folder.

## Unit testing

A minimal unit testing to listing vehicles was implemented, to run the tests execute the command:

```bash
$ make run_tests
```
